services:
  ros2-humble:
    build:
      context: .
      dockerfile: Dockerfile
    image: ros2-humble:latest
    container_name: ros2-humble-persistent
    network_mode: host
    ipc: host
    runtime: nvidia
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=/home/alejp/.Xauthority
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - __NV_PRIME_RENDER_OFFLOAD=1
      - __GLX_VENDOR_LIBRARY_NAME=nvidia
      # CycloneDDS configuration
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      - ROS_DOMAIN_ID=0
    volumes:
      - /home/alejp:/home/alejp
      - /tmp/.X11-unix:/tmp/.X11-unix
    restart: unless-stopped
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'source /opt/ros/humble/setup.bash && ros2 topic list' || exit 0"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s
